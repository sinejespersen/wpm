<html>



<head lang='en'>
  <meta charset='UTF-8'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js'></script>
</head>

<body id="body">

  <h1 tabindex="1">Test af skrivehastighed</h1>
  <p tabindex="2">Den første sætning der skal skrives er:</p>
  <p tabindex="3" id="sentence"></p>

  <input tabindex="4" id="input" style="width:500px; height: 40px;" type="text" />
  <div style="margin-top:30px;">
    <span id="time">00:00</span>
    <span> m:s</span>
  </div>
  <div>
    <span id="sumtime">00:00</span>
    <span> m:s (summeret tid)</span>
  </div>
  <div>
    <span id="words">0</span>
    <span>ord</span>
  </div>


  <p id="result"></p>
  <script>

    let proverbs;
    let proverbsWithSigns;
    let done = false;
    let currentString = '';
    let resultString = '';
    let finishedString = '';
    let timestarted = false;
    let howLongTyped = 0;
    let words = 0;
    let sumSec = 0;
    let sumMin = 0;
    let sec = 0;
    let min = 0;
    let refreshIntervalId = 0;
    let arrayOverview;

    // Fields
    const sentenceField = $('#sentence');
    const inputField = $('#input');
    const wordsField = $('#words');
    const timeField = $('#time');
    const resultsField = $('#result');
    const bodyField = $('#body');

    $.ajax({
      url: 'proverbs.txt',
      dataType: 'text',
      success: function (data) {
        proverbs = data.split('\n');

      }
    });

    $.ajax({
      url: 'proverbsWithSigns.txt',
      dataType: 'text',
      success: function (data) {
        proverbsWithSigns = data.split('\n');
        fixProverbs();

      }
    });

    function fixProverbs() {
      console.log("sfd")
      let arrayOverview = _.map(proverbs, function (num, index) { return { 'sentence': num, 'signed': proverbsWithSigns[index], } });
      sentenceField.html(getSentence());
    }

    function changeSentence() {
      sentenceField.html(getSentence());
    }

    function getSentence() {
      if (proverbs.length > 0) {
        currentString = _.sample(proverbs);
        proverbs = _.without(proverbs, currentString);
        return currentString;
      } else {
        done = true;
        return 'done';
      }
    }

    bodyField.keydown(function (e) {
      if (e.key.toLowerCase() == 'arrowdown') {
        inputField.focus();
      } else if (e.key.toLowerCase() == 'arrowup') {
        sentenceField.focus();
      }
    });

    $(function () {
      if (done) {
        return;
      }
      inputField.keydown(function (e) {
        if (!timestarted) {
          startClock();
        }
        if (e.key.length == 1) {
          resultString += e.key;
        } else if (e.key.toLowerCase() == 'backspace') {
          resultString += '>';
        } else if (e.key.toLowerCase() == 'arrowleft') {
          resultString += '←';
        } else if (e.key.toLowerCase() == 'arrowright') {
          resultString += '→';
        } else if (e.key.toLowerCase() == 'enter') {
          enterHasBeenPressed(resultString);
          timeField.html('00:00');
          wordsField.html(words);
          resultString = '';
          clearInterval(refreshIntervalId);
          timestarted = false;
        } else if (e.key.toLowerCase() == 'escape') {
          finishedProcedure();
          return;
        }
      });
    });

    function finishedProcedure() {
      let wpmString = `wpm is ${wpm()}`;
      finishedString = `${wpmString} \n ${finishedString}`;
      resultsField.html(finishedString.replace(/(\r\n|\n|\r)/gm, '<br>'));
      finishedString = encodeURIComponent(finishedString);
      done = true;
      // window.open(
      //   `mailto:sinejespersen@gmail.com?subject=WPM&body=${finishedString}`
      // );
    }


    function enterHasBeenPressed(result) {
      howLongTyped = timeField.html();
      timeField.html('');
      min = 0;
      sec = 0;
      let stringFromInput = inputField.val();
      let areThereSpecialCharacters = stringFromInput !== result;

      words += parseInt(result.trim().split(/\s+/).length);

      finishedString += `
    ${result}, ${stringFromInput}, ${currentString}, ${howLongTyped}, ${areThereSpecialCharacters}, \n`;

      changeSentence();
      inputField.val('');
      if (done) {
        finishedProcedure();
      }
    }

    function wpm() {
      return words / (sumMin + sumSec / 60);
    }

    function startClock() {
      timestarted = true;
      var handler = function () {
        if (!done && timestarted) {
          sumSec++;
          if (++sec === 60) {
            sumMin++;
            sec = 0;
            sumSec = 0;
            if (++min === 60) min = 0;
          }
          $('#time').html(
            (min < 10 ? '0' + min : min) + ':' + (sec < 10 ? '0' + sec : sec)
          );
          $('#sumtime').html(
            (sumMin < 10 ? '0' + sumMin : sumMin) +
            ':' +
            (sumSec < 10 ? '0' + sumSec : sumSec)
          );
        }
      };

      refreshIntervalId = setInterval(handler, 1000);
      handler();
    }

  </script>
</body>

</html>